<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="utf-8">
    <title>Global Map Creator</title>
</head>
<body>
    <h1>Global xarita yaratish</h1>
    
    <!-- Screenshot yuklash formasi -->
    <form id="uploadForm" enctype="multipart/form-data">
        <label for="screenshot">Screenshotni yuklang:</label>
        <input type="file" id="screenshot" name="screenshot" accept="image/*" required />
        <br/><br/>
        
        <label for="offsetX">Global X offset:</label>
        <input type="number" id="offsetX" name="offsetX" value="0" required />
        <br/><br/>
        
        <label for="offsetY">Global Y offset:</label>
        <input type="number" id="offsetY" name="offsetY" value="0" required />
        <br/><br/>
        
        <button type="button" onclick="processImage()">Process</button>
    </form>
    
    <!-- Rasmni canvasga yuklab olish uchun yashirin canvas -->
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
    async function processImage() {
        const fileInput = document.getElementById('screenshot');
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Rasm faylini tanlang.');
            return;
        }

        // Formadan offset qiymatlarini olish
        const offsetX = parseInt(document.getElementById('offsetX').value);
        const offsetY = parseInt(document.getElementById('offsetY').value);

        const file = fileInput.files[0];
        const img = new Image();
        const reader = new FileReader();

        // Faylni o‘qish
        reader.onload = function(e) {
            img.src = e.target.result;
        };

        // Rasm yuklangach, canvasga chizamiz va piksel ma'lumotlarini o‘qiymiz
        img.onload = async function() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // 1) Avtomatik masshtabni (scale) aniqlash
            // Naiv (soddalashtirilgan) usul: 10 dan 1 gacha bo‘lgan diapazonda tekshiramiz.
            let detectedScale = 1;
            let foundScale = false;

            // Yaxshiroq usulda: kichik bo‘laklarni tekshirib, bir xil rang bloklari bor-yo‘qligini
            // analiz qilish mumkin. Bu misolda soddalashtirilgan tekshiruv.
            for (let s = 10; s >= 1; s--) {
                // Agar rasm o‘lchami s ga bo‘linmas ekan, ehtimol s mos kelmasligi mumkin
                if ((img.width % s === 0) && (img.height % s === 0)) {
                    let consistent = true;
                    // Har s x s blok ichidagi ranglarni tezkor solishtiramiz
                    for (let y = 0; y < img.height; y += s) {
                        for (let x = 0; x < img.width; x += s) {
                            // Blokning chap-ustki pikselini olamiz
                            const p = ctx.getImageData(x, y, 1, 1).data;
                            let blockColor = [p[0], p[1], p[2]];
                            // Blokning markaziga yaqin pikselni olamiz va farqini ko‘ramiz
                            const xp = x + Math.floor(s/2);
                            const yp = y + Math.floor(s/2);
                            const p2 = ctx.getImageData(xp, yp, 1, 1).data;
                            
                            // Agar farq katta bo‘lsa, demak bu s masshtabga to‘g‘ri kelmaydi
                            if (Math.abs(blockColor[0] - p2[0]) > 5 ||
                                Math.abs(blockColor[1] - p2[1]) > 5 ||
                                Math.abs(blockColor[2] - p2[2]) > 5) {
                                consistent = false;
                                break;
                            }
                        }
                        if (!consistent) break;
                    }
                    
                    if (consistent) {
                        detectedScale = s;
                        foundScale = true;
                        break;
                    }
                }
            }

            if (!foundScale) {
                alert("Masshtab avtomatik aniqlanmadi, default = 1 bo‘ldi.");
            }

            // 2) Endi detectedScale bo‘yicha har bir blokning o‘rtacha yoki markaz rangini olamiz
            let mapData = [];
            const scaledWidth = img.width / detectedScale;
            const scaledHeight = img.height / detectedScale;

            for (let by = 0; by < scaledHeight; by++) {
                for (let bx = 0; bx < scaledWidth; bx++) {
                    const x = bx * detectedScale;
                    const y = by * detectedScale;
                    // Blokning markaziy pikselini olamiz
                    const xp = x + Math.floor(detectedScale / 2);
                    const yp = y + Math.floor(detectedScale / 2);
                    const d = ctx.getImageData(xp, yp, 1, 1).data;
                    
                    // R, G, B qiymatlari
                    const color = {
                        r: d[0],
                        g: d[1],
                        b: d[2]
                    };
                    
                    // Global koordinatalar (offsetni hisobga olgan holda)
                    const globalX = offsetX + bx;
                    const globalY = offsetY + by;

                    mapData.push({
                        x: globalX,
                        y: globalY,
                        color: color
                    });
                }
            }

            // 3) Tayyor ma'lumotni (mapData) AJAX orqali PHP backend ga (save_map.php) yuboramiz
            try {
                const response = await fetch('save_map.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mapData)
                });
                const result = await response.json();
                alert("Serverdan javob: " + result.message);
            } catch (error) {
                console.error(error);
                alert("Serverga ma'lumot yuborishda xatolik yuz berdi.");
            }
        };

        // Faylni o‘qishni boshlaymiz
        reader.readAsDataURL(file);
    }
    </script>
</body>
</html>
